machine:
  environment:
    TERRAFORM_VERSION: 0.7.3
    STATE_BUCKET: circleci-akerl-dns
    AWS_DEFAULT_REGION: us-east-1
dependencies:
  pre:
  - curl -sLo /tmp/terraform.zip "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip"
  - sudo unzip -d /usr/local/bin /tmp/terraform.zip
  override:
  - /usr/local/bin/terraform remote config -backend=S3 -backend-config="bucket=${STATE_BUCKET}" -backend-config="key=state/terraform.tfstate"
  - /usr/local/bin/terraform get terraform
test:
  override:
  - /usr/local/bin/terraform plan -out=terraform.plan terraform
deployment:
  release:
    tag: /.*/
    commands:
    - /usr/local/bin/terraform apply terraform.plan
    - /usr/local/bin/terraform remote push

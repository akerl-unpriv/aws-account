machine:
 environment:
    GO_VERSION: "1.10"
    GOPATH: /tmp/gopath
    TERRAFORM_VERSION: 0.11.3
    AWS_DEFAULT_REGION: us-east-1
dependencies:
  pre:
  - curl -sLo /tmp/golang.tar.gz "https://storage.googleapis.com/golang/go${GO_VERSION}.linux-amd64.tar.gz"
  - sudo rm -rf /usr/local/go
  - sudo tar -C /usr/local -xf /tmp/golang.tar.gz
  - curl -sLo /tmp/terraform.zip "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip"
  - sudo unzip -d /usr/local/bin /tmp/terraform.zip
  override:
  # Switch this back once https://github.com/golang/go/issues/17522 is fixed
  - rm -rf $GOPATH
  - go get github.com/akerl/terraform-provider-awscreds
  - mkdir -p ~/.terraform.d/plugins
  - ln -s $GOPATH/bin/terraform-provider-awscreds ~/.terraform.d/plugins/terraform-provider-awscreds
  - /usr/local/bin/terraform init -upgrade -input=false
test:
  override:
  - test $(/usr/local/bin/terraform fmt -write=false | tee /dev/stderr | wc -c) -eq 0
  - terraform plan -detailed-exitcode -input=false
